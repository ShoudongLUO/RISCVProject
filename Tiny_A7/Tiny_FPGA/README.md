# FPGA README

## 重要说明

1. 这是FPGA的修改日志。
2. **请在这里简单描述一下你的每次修改日志。每个`.v`, `.sv`, `.svh`文件的头部的注释里也有修改日志，在改完某个文件后也请简单记录。**
3. 脚本`add_header.sh`可以批量为未添加头部日志注释的类似文件添加标准日志格式。
4. 在Vivado每次运行后，可能会产生新的日志文件、缓存文件和配置文件。如果没有必要，请不要上传这些文件。可以使用
```
git checkout -- <path/to/your/folder/>
```
来放弃工作区某个文件夹的修改（【会直接强制回滚这些文件！谨慎使用】）。

进入该文件夹后，你也可以直接运行这个脚本，在提交前回滚不必要的缓存文件等修改：
```
chmod +x gitback.sh // 只需第一次运行脚本时运行
./gitback.sh
```
它会回滚并删除未跟踪的文件: 

- `project/Tiny_FPGA/Tiny_FPGA.cache`

- `project/Tiny_FPGA/Tiny_FPGA.hw`

- `project/Tiny_FPGA/Tiny_FPGA.ip_user_files`

- `project/Tiny_FPGA/Tiny_FPGA.runs`

- `project/Tiny_FPGA/Tiny_FPGA.sim`

- `project/Tiny_FPGA/Tiny_FPGA.xpr`

保留包含`project/Tiny_FPGA/Tiny_FPGA.srcs`在内其它文件改动（【会直接强制回滚以上的文件并删除未跟踪文件！谨慎使用】）。

## 修改日志

1. 【example】[what you did] by [who], [yyyy-mm-dd]:
   1. ...
      1. ...
      2. ...
   2. ...
   3. ...
2. 【示例】创建了`README.md`文件、`gitback.sh`脚本 by Albert, 2025-07-25:
   1. 这是第一项修改
      1. 说明一
   2. 这是第二项修改
      1. 说明二
3. 将FPGA版本重新设置回了BRAM实现。SRAM相关配置现在只在ASIC版本内存在。by Albert, 2025-07-25
4. 添加了RIB的注释 by Albert，2025-07-26
5. 修改了FIFO by Albert，2025-07-27
   1. 原来的FIFO只能缓存1个字节，CPU卡死概率极高、读写速度极慢（高CPU中断频率，数据丢失风险），单次只能读写一个字节，
   2. 现在可以缓存16个字节，读写速度提升，降低CPU负载，提高稳定性
   
6. 修改了BUGsssss by Albert，2025-07-27
   1. 识破修复了`spi_wrapper.v`和`i2c_master.v`文件名被故意伪装成`i2c_wrapper.v`和`spi_wrapper.v`的bug
   2. 时钟分频逻辑错误
      1. 分频器只有在`scl_in == 1'b1`时才计数，违反了I2C主机应该完全控制时钟频率的原则
      2. 当从机进行时钟延展时，分频器停止计数
   3. 超时计数器使用阻塞赋值
      1. 否则有时Vivado正确，实际上板上运行错误
   4. 位计数逻辑错误
      1. 主机码发送完成判断错误：I2C字节传输是8位，计数从0到7，所以7表示发送完成
   5. 状态寄存器更新；添加了FIFO状态信息
   6. RIB握手逻辑修复
      1. 修复前：`wen`信号在整个握手期间有效，导致FIFO重复写入
      2. 修复后：只在握手成功时产生一个时钟周期的使能脉冲
   7. I2C Master:
      1. 时钟分频逻辑修复
         1. 修复前：分频器只有在`scl_in == 1'b1`时才计数，违反I2C主机控制时钟原则
         2. 修复后：分频器连续运行，不依赖`scl_in`状态
      2. 超时计数器修复
         1. 修复前：使用阻塞赋值，可能导致仿真与综合不一致
      3. 位计数逻辑修复
         1. 修复前：主机码发送完成判断错误，8表示发送了9位
         2. 修复后：I2C字节传输是8位，计数从0到7，所以7表示发送完成
      4. 计数器更新条件修复
         1. 修复前：计数器更新依赖外部`SCL`信号，在主机模式下会导致状态机卡死
         2. 修复后：计数器更新只依赖内部分频器，主机完全控制时序
      5. 启动条件简化
         1. 修复前：要求写操作时FIFO必须非空才能启动，但地址传输不需要FIFO数据
         2. 修复后：简化启动条件：只要使能就可以启动，地址阶段不依赖FIFO状态
   8. 通过I2C接口验证，添加了`i2c_complete_tb.v`文件，用于验证I2C接口的正确性 
      1. 验证了RIB总线接口
      2. 验证了16深度FIFO缓冲
      3. 验证了I2C主机协议符合标准
      4. 验证了地址传输准确性
      5. 验证了START/STOP条件时序标准
      6. 验证了ACK/NACK处理机制
      7. 验证了状态机逻辑
7. 提交了经过验证的I2C模块，并在`sdk/example`中添加了i2c的配套程序，已通过A7开发板的板上EEPROM验证读写功能正常，重整了`project`目录结构，将模块测试放到特定的子文件夹中 by Yuxin, 2025-8-21 
   1. 修复了之前i2c模块的c程序部分bug，并通过`W25Q64`的闪存模块完成了spi协议的测试，提交相应的spi测试程序. by Yuxin
8. 将ADC+UDP模块整合入Bram版本 by Shoudong, 2025-9-0